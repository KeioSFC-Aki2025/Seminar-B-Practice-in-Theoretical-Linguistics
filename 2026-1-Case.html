<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Course Schedule Viewer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#e6f0ff;
  --card:#ffffff;
  --muted:#555555;
  --accent:#1e3a8a;
  --accent-2:#3b82f6;
  --success:#16a34a;
  --danger:#1e3a8a;
  --radius:12px;
  --muted-gray-accent: #64748b; /* 落ち着いたグレーのアクセントカラー */
  --muted-gray-light: #94a3b8;  /* 明るめのグレー（ボーダー用） */
  --muted-gray-bg: #f1f5f9;     /* 薄いグレーの背景色（ヘッダー用） */
  --muted-gray-border: #e2e8f0; /* 境界線の色 */
  
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #ffffff 40%);}
.wrap{max-width:1200px;margin:0 auto 32px auto;padding:20px}
header {
  /* 全幅表示 */
  width: 100%;
  /* 上部に余白を設定（元々.wrapにあったマージンを代替） */
  padding-top: 32px;
  /* 既存のflex設定をリセット */
  display: block;
}
.header-content {
  max-width: 1200px; /* .wrapと同じ最大幅 */
  margin: 0 auto;    /* 中央揃え */
  padding: 0 20px;   /* .wrapと同じ左右のパディング */
}
h1{margin:0;font-weight:700;font-size:1.6rem;color:var(--accent)}
p.lead{
  /* マージン調整（下部に追加） */
  margin: 4px 0 16px 0;
  /* 丸みのあるフォントを指定 */
  font-family: 'M PLUS Rounded 1c', 'Inter', system-ui, sans-serif;
  /* フォントサイズを大きく */
  font-size: 1.15rem;
  /* 行間を広げて読みやすく */
  line-height: 1.7;
  /* 色を濃いアクセントカラー(var(--accent) = #1e3a8a)に設定 */
  color: var(--accent);
  /* 装飾を追加して目立たせる */
  background-color: #f0f9ff; /* ごく薄い水色の背景 */
  padding: 15px 20px;
  border-radius: var(--radius); /* カードと同じ角丸を適用 */
  border-left: 6px solid var(--accent-2); /* 左側にアクセントライン */
}
.course-header {
  text-align: center;
  margin-bottom: 24px;
  padding-bottom: 20px;
  /* 下に境界線を追加して区切りを明確に */
  border-bottom: 1px solid #e6eef8;
}
/* メインタイトル */
.course-header .title {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent);
  margin: 0;
}
/* サブタイトル */
.course-header .subtitle {
  font-size: 1.2rem;
  /* 色を少し落ち着かせる */
  color: var(--muted);
  margin: 8px 0;
}
/* 詳細（学期・時限） */
.course-header .details {
  margin: 16px 0;
  font-size: 1rem;
  /* 詳細も少し目立つように色付け */
  color: var(--accent);
  line-height: 1.5;
}
/* 短縮タイトル */
.course-header .short-title {
  font-size: 1.4rem;
  font-weight: 600;
  color: var(--accent);
  margin: 0;
}
.grid{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:20px}
@media (max-width:880px){ .grid{grid-template-columns:1fr;} }
.card{
	background:var(--card);
	border-radius:var(--radius);
	box-shadow:0 6px 18px rgba(15,23,42,0.06);
	padding:20px;
	}
.controls{display:flex;gap:10px;flex-wrap:wrap}
.seg{
  display:flex;
  background:#cfe0ff;
  border-radius:999px;
  padding: 4px;
  margin: 0;
}
/* 修正箇所: トグルボタンのスタイル */
.seg button{
  border:0;
  background:transparent;
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
  font-weight:600;
  color:var(--muted); 
  font-size: 16px; 
  
 /* position: relative; と z-index: 10; を削除 */
  line-height: 1.2; 
  
  -webkit-tap-highlight-color: transparent;
  
}
.seg button.active{
  background:linear-gradient(180deg,var(--accent),var(--accent-2));
  color:#fff;
  
  font-size: 16px; 
}
select, input[type="search"]{padding:8px 10px;border-radius:10px;border:1px solid #e6eef8;background:white;font-size:0.95rem}
.tablewrap{overflow:auto;margin-top:14px;border-radius:8px}
table{
	width:100%;
	border-collapse:collapse;
/*	min-width:720px;*/
	white-space: pre-line;
	table-layout: fixed;
	}
/* PC表示時の列幅設定（より広い画面での動作） */
table colgroup col:nth-child(1) { width: 6% !important; }  /* Session */
table colgroup col:nth-child(2) { width: 12% !important; } /* Date */
table colgroup col:nth-child(3) { width: 12% !important; } /* Chapter */
table colgroup col:nth-child(4) { width: 27% !important; } /* Class  */
table colgroup col:nth-child(5) { width: 43% !important; } /* Docs  */
thead th{
	position:sticky;
	top:0;
	background:linear-gradient(180deg,#ffffff,#e6f0ff);
	padding:12px 14px;
	text-align:left;
	font-size:0.95rem;
	border-bottom:1px solid #e6eef8
}
tbody td{
    padding:12px 14px;
    border-bottom:1px dashed #eef4fb;
    vertical-align:top;
    /* ↓↓↓ 以下2行を追加 ↓↓↓ */
    word-break: break-word;     /* 長い文字列を強制的に折り返す */
    overflow-wrap: break-word;  /* 標準的な折り返し設定 */
}
tbody tr:not(.section-title-row):hover{background:linear-gradient(90deg,rgba(59,130,246,0.05),transparent)}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#dbeafe;border:1px solid #bfdbfe;color:var(--accent);font-weight:600}
.video-list{
  margin:0;
  padding:0;
  list-style-type: none;
}
.video-list li{margin:6px 0}
.meta{color:var(--muted);font-size:0.9rem}
.hw-due{ color:#381d9b; font-weight:700; }
.hw-past{ color:#9ca3af; font-weight:600 }
li::marker {
  content: "";
  font-size: 1.2em;
}
body {
  font-size: 16px;  /* PC用 */  
}
@media (max-width: 768px) {
  body {
    font-size: 14px; /* タブレット用 */
  }
}
@media (max-width: 480px) {
  body {
    font-size: 8px; /* スマホ用 */
	/* padding : 0;*/
  }
  button {
    /*  垂直パディングを増やし、タップ領域を広げる */
    padding: 6px 25px !important;
    display: inline-block; 
    font-size: 8px !important
	}
  table th {
    font-size: 7px !important;
  }
   select {
    font-size: 8px !important;
    padding: 4px 2px;
  }
  input, textarea {
    font-size: 8px !important;
    padding: 4px 2px !important;
  }
  
  .wrap {
    max-width: 100%; /* 最大幅の制限を解除 */
    margin: 0;      /* 上下のマージンを解除し、左右の自動中央寄せも解除 */
    padding: 0;     /* 全体のパディングを解除 */
  }
  /* .card クラスもパディングを調整または解除 */
  .card {
    border-radius: 0; /* 角丸をなくして画面端に合わせる（任意） */
    padding: 10px;    /* カードの内部パディングを小さくする（例: 20pxから10pxへ） */
  }
  
  .tablewrap {
		width: 100%;          /* 画面幅に合わせる */
		max-width: 100%;      /* 余計に大きくならないように */
		overflow-x: auto;     /* 万が一はみ出す場合は横スクロール */
		margin: 0px 0;   /* 上下14px, 左右は自動で中央寄せ */
		padding: 0;
		width: 100vw;
  }
  table {
		min-width: auto;   /* スマホでは横幅制限を外す */
		table-layout: fixed; /* 内容に合わせて列幅を調整 */
		border-collapse: collapse;  /* 余分な隙間をなくす */
		border-spacing: 0
	}
	th, td {
		font-size: 7px !important;
		padding:5px  5px;        
		word-break: break-word;  
	}
	/* 列幅の調整 */
 /* 5列構成に対応 */
  table colgroup col:nth-child(1) { width: 8%; }  /* Session */
  table colgroup col:nth-child(2) { width: 15%; } /* Date */
  table colgroup col:nth-child(3) { width: 17%; } /* Chapter */
  table colgroup col:nth-child(4) { width: 40%; } /* Class */
  table colgroup col:nth-child(5) { width: 20%; } /* Docs */
  #scheduleTable {
    width: 100%;
    table-layout: fixed; /* 列幅を均等割り */
    border-collapse: collapse;
    border-spacing: 0;
  }
  
  #scheduleTable th, #scheduleTable td {
    font-size: 7px;       /* 小さめにして列を収める */
    padding: 5px 5px;     /* 列間の余白を最小化 */
    word-break: break-word; /* 長い文字列は折り返し */
    white-space: normal;   /* nowrap を解除 */
    /* overflow: hidden;*/  
  }
  
 
  .video-btn, a.handout-link {
   /* パディングを上下左右均等に小さく */
    padding: 3px 6px !important; 
    /* 縦に並ぶときのボタン間のマージンを削除 */
    margin: 0 !important; 
    /* ボタンを左寄せに */
    text-align: left; 
	
    display: block;
    font-size: 7px; /* ←変更後 */
  }
  
  
    /* Videos列のセル内のテキスト全般 */
    table td.col4, 
    /* Videos列のボタンのテキスト */
    .col4 .video-btn {
        /* フォントサイズを7pxからさらに小さく */
        font-size: 6px !important; 
    }
    
    /* ボタンのパディングも調整してスペースを詰める */
    .col4 .video-btn {
        padding: 4px 6px !important; 
    }
  
}
.grid {
  display: flex;
  margin: 0 0;
  padding: 0;
  width: 100%;       /* デフォルト: PCでは6割 */
  max-width: 800px; /* 上限幅 */
  }
  
  .sessionTableWrapper {
  display: block;  /* gridの影響を外す */
  overflow-x: auto;
}
.video-btn{
  display: inline-block; /* aタグをボタンとして表示するため追加 */
  text-decoration: none; /* aタグの下線を消去 */
  background:var(--accent-2);
  color:#fff;
  border:none;
  padding:10px 14px; /* パディングを少し増加 */
  border-radius:6px;
  cursor:pointer;
  font-size:10pt;
  text-align:left;
  margin-bottom: 4px; /* 縦に並んだ際の余白 */
}
/* ★ 変更点4: 日付が未来の期限の場合のボタン色 */
.hw-due .video-btn {
  background: var(--accent-2); /* 期限切れの場合の背景色 */
  color: #fff;
}
/* ★ 変更点5: 日付が過去の期限の場合のボタン色 */
.hw-past .video-btn {
  background: #cccccc; /* 期限内の背景色 */
  color: #666666;
}
a.handout-link{
	font-weight:600;
	padding:8px 12px;
	white-space: nowrap;
	border-radius:6px;
	border:1px solid rgba(59,130,246,0.12);
	text-decoration:none;
	background:#eef6ff;
	color:var(--accent-2);
	display:inline-block;
	margin-right:6px
}
.video-btn.disabled, .handout-link.disabled {
  background: #cccccc !important;
  color: #666666 !important;
  border-color: #aaaaaa !important;
  cursor: not-allowed;
  opacity: 0.7;
}
#sessionOverviewContainer .session-panel {
    margin-top: 28px;
}
#sessionOverviewContainer .session-panel h2 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 10px;
    padding-bottom: 5px;
    /* タイトルの下に線を引いて強調 */
    border-bottom: 2px solid var(--accent-2);
}
/* 最初のパネルは上部マージンを調整 */
#sessionOverviewContainer .session-panel:first-child {
    margin-top: 20px;
}
/* パネルタイトル(h2)のスタイル変更 */
/* 詳細度を高めるため .session-panel.muted-panel とする */
.session-panel.muted-panel h2 {
    color: var(--muted-gray-accent);
    /* タイトルの下の線を明るいグレーに変更 */
    border-bottom-color: var(--muted-gray-light);
}
/* テーブルヘッダー(th)のスタイル変更 (既存のスタイルを上書き) */
.session-panel.muted-panel table thead th {
    /* 既存の青いグラデーションをグレー系で上書き */
    background: linear-gradient(180deg, #ffffff, var(--muted-gray-bg));
    color: var(--muted-gray-accent);
    border-bottom-color: var(--muted-gray-border);
}
/* ↓↓↓ 変更: タイトル行(.section-title-row)を除外してホバーを適用 ↓↓↓ */
/* テーブル行のホバーエフェクトもグレー系に変更 (既存のスタイルを上書き) */
.session-panel.muted-panel table tbody tr:not(.section-title-row):hover {
    /* 既存の青みがかったグラデーションをグレー系で上書き */
    background: linear-gradient(90deg, rgba(100, 116, 139, 0.08), transparent);
}
/* データがない場合のメッセージスタイル */
.empty-message-cell {
    text-align: center !important;
    padding: 20px !important;
    color: var(--muted) !important;
    font-style: italic;
}
/* ↓↓↓ 追加: スケジュール表のセクションタイトル行のスタイル ↓↓↓ */
.section-title-row td {
  text-align: center; /* 中央揃え */
  font-weight: 700;
  /* 既存の変数を利用して統一感を出す */
  background-color: var(--muted-gray-bg); 
  color: var(--accent);
  padding: 14px 14px;
  /* 境界線を少しはっきりさせる */
  border-bottom: 1px solid var(--muted-gray-border);
}
/* Video行（2行目）のスタイル */
.video-row td {
  background-color: #f8fafc;
  border-bottom: 2px solid #e2e8f0;
  /* padding-left: 40px !important; ← 削除（テーブルの構造で位置合わせするため不要） */
  vertical-align: top; /* 上揃えにしてDocs列の開始位置と合わせる */
}
.video-spacer {
  background-color: #ffffff !important; /* ★ここを白に変更 */
  border-right: none; /* コンテンツとの境界線を消してつながりをスムーズに */
  /* border-bottom: none; ← もし左側の空白部分だけ下線も消したい場合は、ここを有効にしてください */
}
/* Video行のラベル */
.video-row-label {
  font-weight: 700;
  font-size: 0.9em;
  color: var(--accent);
  margin-bottom: 6px;
  display: block;
}
footer{margin-top:18px;color:var(--muted);font-size:0.9rem;text-align:center}
</style>
</head>
<body>
    <header>
      <div class="header-content">
        <div class="course-header">
            <h1 class="title">理論言語学実践</h1>
            <p class="subtitle">（研究会B1）</p>
            <div class="details">
                2026年度春学期（Spring 2026）<br>
                金曜日5限（Friday, the 5th period, tentatively）
            </div>
            <h2 class="short-title">格 Case</h2>
        </div>
        <p class="lead">
          この研究会「理論言語学実践」では、学期ごとに言語学の様々な枠組みに触れ、対象を分析し、理論言語学における参加者の知識と分析力を高めることを目標とする。今学期は、格（Case）に関する諸論文を輪読しながら、先学期の「理論言語学入門」で学んだ内容が実践でどのように活かされているのかを理解し、自らがリサーチクエスチョンを立て、研究を遂行する力を育んでいく。
		  <br>
		  ※上記の理由から同授業で扱われた内容の理解が前提となるが、同程度の知識を有している、ないしは、極めて高い意欲と理解力を有する学生については特別に履修、ないしは、聴講を許可することもある。
          </p>
        <p class="lead">
          <b>成績評価</b>：発表（50点）＋期末レポート（50点）<br>
          <b>期末レポート提出期限（暫定）</b>：8月5日（水）18:00厳守
          </p>
 
		<p class="lead">
		お知らせ：<br>
	<b>休講情報</b>：<font color ="red">5月22日（金）</font>は、学会出張のため休講<br>
	<b>補講情報</b>：<font color ="blue">6月1日（金）</font>は、上記分の補講<br>	
	<b>休講情報</b>：<font color ="red">6月19日（金）</font>は、学会出張のため休講<br>
	<b>補講情報</b>：<font color ="blue">7月24日（金）</font>は、上記分の補講<br>
	<b>夏合宿（特プロ／予定）</b>：
          <b>夏合宿（特プロ／予定）</b>：8月～9月のいずれか（2泊3日、関東近郊を予定）
          </p>
      </div>
    </header>
  <div class="wrap">
	※下記のスケジュールは暫定版で、今後変更されることがありうることを念頭において御覧ください。
    <div class="card">
		<div class="controls">
			<div class="seg" role="tablist" aria-label="view mode">
                <button id="btnFull" role="tab" aria-selected="false">学期全体</button>
				<button id="btnSession" class="active" role="tab" aria-selected="true">直前／直後の日程</button>
			</div>
            <select id="sessionSelect" aria-label="Select session" style="display: none;"></select>
			<input type="search" id="searchBox" placeholder="Search class / reading / homework">
		</div>
		<div class="card" style="margin-top:14px;padding:10px;color:#1e40af;font-weight:600" id="generalComment">
			<p>Class on November 7 is cancelled.</p>
		</div>
        <template id="tableTemplate">
    <table>
        <colgroup>
            <col class="col1">
            <col class="col-date">
            <col class="col-chapter"> 
			<col class="col2">
            <col class="col3">
        </colgroup>
        <thead>
            <tr>
                <th class="col1"></th>
                <th class="col-date">Date</th>
                <th class="col-chapter">Chapter</th> 
				<th class="col2">Class</th>
                <th class="col3">Docs</th>
            </tr>
        </thead>
    <tbody></tbody>
    </table>
</template>
        <div id="fullScheduleContainer" class="tablewrap" style="display: none;">
             </div>
        <div id="sessionOverviewContainer">
            <section class="session-panel muted-panel" id="panelLast">
                <h2>Last Class</h2>
                <div class="tablewrap">
                    </div>
            </section>
            <section class="session-panel" id="panelNext">
                <h2>Next Class</h2>
                <div class="tablewrap">
                     </div>
            </section>
            <section class="session-panel muted-panel" id="panelAfterNext">
                <h2>Class After Next</h2>
                <div class="tablewrap">
                    </div>
            </section>
        </div>
        </div>
  
   <p></p>
  </div>
  <script>
// =====================
// Embedded scheduleData
// =====================
const scheduleData =
[
  {
    "session": "Part",
    "class": "Introduction"
  },
  {
    "session": "1",
    "class": "イントロダクション：自己紹介とテーマ紹介",
    "date": 46122,
    "video": "論文1",
    "deadlineHW": 46122,
    "deadlineClass": 46122,
    "date2": "46122"
  },
  {
    "session": "Part",
    "class": "トピック１：受動態"
  },
  {
    "session": "2",
    "class": "受動態１",
    "date": 46129,
    "video": "論文２",
    "deadlineHW": 46129,
    "deadlineClass": 46129,
    "date2": "46129"
  },
  {
    "session": "3",
    "class": "受動態２",
    "date": 46136,
    "video": "論文３",
    "deadlineHW": 46136,
    "deadlineClass": 46136,
    "date2": "46136"
  },
  {
    "session": "4",
    "class": "受動態３",
    "date": 46143,
    "video": "論文４",
    "deadlineHW": 46143,
    "deadlineClass": 46143,
    "date2": "46143"
  },
  {
    "session": "Part",
    "class": "トピック2：可能表現"
  },
  {
    "session": "5",
    "class": "可能文１",
    "date": 46150,
    "video": "論文５",
    "deadlineHW": 46150,
    "deadlineClass": 46150,
    "date2": "46150"
  },
  {
    "session": "6",
    "class": "可能文２",
    "date": 46157,
    "video": "中間発表（4年生）",
    "deadlineHW": 46157,
    "deadlineClass": 46157,
    "date2": "46157"
  },
  {
    "format": "休講",
    "date": 46164,
    "deadlineHW": 46164,
    "deadlineClass": 46164,
    "date2": "46164"
  },
  {
    "session": "7",
    "class": "中間発表（4年生）",
    "date": 46171,
    "video": "論文６",
    "deadlineHW": 46171,
    "deadlineClass": 46171,
    "date2": "46171"
  },
  {
    "session": "Part",
    "class": "トピック３：与格主語"
  },
  {
    "session": "8",
    "class": "与格主語１",
    "format": "補講",
    "date": 46178,
    "video": "論文７",
    "deadlineHW": 46178,
    "deadlineClass": 46178,
    "date2": "46178"
  },
  {
    "session": "9",
    "class": "与格主語２",
    "date": 46185,
    "video": "論文8",
    "deadlineHW": 46185,
    "deadlineClass": 46185,
    "date2": "46185"
  },
  {
    "format": "休講",
    "date": 46192,
    "deadlineHW": 46192,
    "deadlineClass": 46192,
    "date2": "46192"
  },
  {
    "session": "Part",
    "class": "トピック４：使役"
  },
  {
    "session": "10",
    "class": "使役１",
    "date": 46199,
    "video": "論文９",
    "deadlineHW": 46199,
    "deadlineClass": 46199,
    "date2": "46199"
  },
  {
    "session": "11",
    "class": "使役２",
    "date": 46206,
    "video": "論文10",
    "deadlineHW": 46206,
    "deadlineClass": 46206,
    "date2": "46206"
  },
  {
    "session": "Part",
    "class": "トピック５：能格言語"
  },
  {
    "session": "12",
    "class": "能格言語１",
    "date": 46213,
    "video": "論文11",
    "deadlineHW": 46213,
    "deadlineClass": 46213,
    "date2": "46213"
  },
  {
    "session": "13",
    "class": "能格言語２",
    "date": 46220,
    "video": "期末発表（1/2/3年生）",
    "deadlineHW": 46220,
    "deadlineClass": 46220,
    "date2": "46220"
  },
  {
    "session": "14",
    "class": "期末発表（1/2/3年生）※終了後、懇親会を予定",
    "format": "補講",
    "date": 46227,
    "deadlineHW": 46227,
    "date2": "46227"
  }
]
;
const GeneralComment = "";
// セクションタイトルの識別子を定義
const SECTION_TITLE_IDENTIFIER = "Part";
// =====================
// UI elements
// =====================
const btnSession     = document.getElementById('btnSession');
const btnFull        = document.getElementById('btnFull');
const sessionSelect  = document.getElementById('sessionSelect');
// const tbody = document.querySelector('#scheduleTable tbody'); // このIDは存在しないため削除
const searchBox = document.getElementById('searchBox');
const generalCommentDiv = document.getElementById('generalComment');
const fullScheduleContainer = document.getElementById('fullScheduleContainer');
const sessionOverviewContainer = document.getElementById('sessionOverviewContainer');
const tableTemplate = document.getElementById('tableTemplate');
// ----------------------
// Utilities
// ----------------------
/**
 * スケジュールデータの日付 (YYYY/MM/DD形式) をパースする。
 * 期限はその日の終わり (23:59:59) とする。
 */
function parseDeadlineAsLocal(deadline) {
  if (!deadline) return null;
  // 数値（Excelシリアル値）を日付オブジェクトに変換
  let serial = Number(deadline);
  if (isNaN(serial)) return null;
  const date = new Date((serial - 25569) * 86400 * 1000);
  date.setHours(23, 59, 59); // 期限をその日の終わりに設定
  return date;
}
/**
 * コンテンツの利用開始日時 (MM/DD/YYYY形式または HH:mm MM/DD/YYYY形式) をパースする。
 * ※この関数はscheduleData本体ではなく、handoutやvideo内の[after ...]タグを処理するために使用される。
 */
function parseAvailableFromAsLocal(dateStr){
  if(!dateStr) return null;
  let hour = 0;
  let minute = 0;
  let datePart = dateStr.trim(); // デフォルトは時刻なしと仮定
  // "13:00 11/15/2025" のような時間指定があるかチェック
  const timeMatch = dateStr.match(/^(\d{1,2}):(\d{2})\s+(.*)$/);
  
  if (timeMatch) {
    // 時刻指定がある場合
    hour = parseInt(timeMatch[1], 10);
    minute = parseInt(timeMatch[2], 10);
    datePart = timeMatch[3]; // 残りの日付部分
  }
  // 日付部分 (例: "11/15/2025") をパース
  const dateParts = datePart.split('/').map(x=>parseInt(x,10));
  if(dateParts.length < 3 || dateParts.some(isNaN)) return null;
  
  // MM/DD/YYYY形式なので [m, d, y] で受け取る
  const [m, d, y] = dateParts;
  // 利用開始は指定日の指定時刻 (デフォルトは 00:00:00)
  return new Date(y, m-1, d, hour, minute, 0);
}
/**
 * 汎用パーサ: 改行・カンマで分割し、
 * 各パートについて "ラベル<url>" の形式を検出して {label, url} を返す。
 * url が見つからなければ url=null。
 */
function parseEntries(fieldStr){
  if(!fieldStr) return [];
  try {
    // split on newline or comma (with optional spaces) but keep meaningful tokens
    const parts = fieldStr.split(/\n|,(?=\s)|,(?=\S)|, /).map(s=>s.trim()).filter(Boolean);
    const entries = [];
    // regex to capture "anything <url>" and optional "[after date]" (case-insensitive)
    /* ↓↓↓ 変更: [after 日付] をオプションでキャプチャ ↓↓↓ */
    const regex = /^(.*?)<([^>]+)>(?:\s*\[after\s+([^\]]+)\])?$/i;
    parts.forEach(p=>{
      const m = p.match(regex);
      if(m){
        /* ↓↓↓ 変更: availableAfterStr を追加 ↓↓↓ */
        const availableAfterStr = m[3] ? m[3].trim() : null;
        entries.push({
          label: m[1].trim(),
          url: m[2].trim(),
          availableAfterStr: availableAfterStr
        });
      } else {
        /* ↓↓↓ 変更: availableAfterStr を追加 ↓↓↓ */
        entries.push({label: p, url: null, availableAfterStr: null});
      }
    });
    return entries;
  } catch(e){
    return [];
  }
}
/* ↓↓↓ 追加: 現在日時に関連するセッション(Last/Next/AfterNext)を見つける関数 ↓↓↓ */
/**
 * 現在日時を基準に、Last, Next, After Next の3つのセッションを特定する。
 */
function findRelevantSessions() {
    const today = new Date();
    let lastClass = null;
    let nextClass = null;
    let afterNextClass = null;
    const pastClasses = [];
    const futureClasses = [];
    // scheduleDataが時系列順に並んでいることを前提とする
    for (const item of scheduleData) {
        /* ↓↓↓ 修正: 定義した識別子（"Part"）を使って判定 ↓↓↓ */
        if (item.session === SECTION_TITLE_IDENTIFIER) {
            continue;
        }
        /* ↑↑↑ 修正 ↑↑↑ */
        // 判定基準となる日付は deadlineClass を優先し、なければ date を使用する
        const dateStr = item.deadlineClass || item.date;
        if (dateStr) {
             // parseDeadlineAsLocal は指定日の 23:59:59 を返す
             const sessionDateEnd = parseDeadlineAsLocal(dateStr);
             
             // 日付が正しくパースできた場合のみ判定を行う
             if (sessionDateEnd && !isNaN(sessionDateEnd.getTime())) {
                 if (today > sessionDateEnd) {
                     // 終了時刻を過ぎている場合は過去
                     pastClasses.push(item);
                 } else {
                     // まだ終了していない場合は未来（当日も含む）
                     futureClasses.push(item);
                 }
             } else {
                // 日付形式が不正などでパースできなかった場合は、ログを出力しつつ未来として扱う（安全側）
                console.warn("Could not parse date for session:", item.session, dateStr);
                futureClasses.push(item);
             }
        } else {
            // 日付がない場合 (例: Session 0の開始前や、Testなどリストの最後)。
            // これらは未来の予定として扱う。
            futureClasses.push(item);
        }
    }
    
    // Last Classの特定
    if (pastClasses.length > 0) {
        // 過去のクラスの中で最後（直近）のもの
        lastClass = pastClasses[pastClasses.length - 1];
    } else {
        // 過去のクラスがまだない場合（コース開始前）、Class 0を探して表示
        const classZero = scheduleData.find(i => String(i.session) === "0");
        if (classZero) {
             lastClass = classZero;
        }
    }
    // Next Class と After Next Class の特定
    // コース開始前（pastClassesが空）の場合、Session 0がLast Classで表示されるため、Nextからは除外する。
    let relevantFutureClasses = futureClasses;
    if (pastClasses.length === 0) {
        relevantFutureClasses = futureClasses.filter(i => String(i.session) !== "0");
    }
    if (relevantFutureClasses.length > 0) {
        // 未来のクラスの最初のものから順に特定
        let nextIndex = 0;
        
        // Next Class
        if (nextIndex < relevantFutureClasses.length) {
            nextClass = relevantFutureClasses[nextIndex];
            nextIndex++;
        }
        // After Next Class
        if (nextIndex < relevantFutureClasses.length) {
            afterNextClass = relevantFutureClasses[nextIndex];
        }
    }
    
    return { lastClass, nextClass, afterNextClass };
}
/* ↑↑↑ 追加 ↑↑↑ */
// ----------------------
// Rendering
// ----------------------
function init(){
  generalCommentDiv.textContent = GeneralComment;
  /* ↓↓↓ 変更: 内部IDやドロップダウン生成ロジックは不要なため削除 ↓↓↓ */
  /* ↓↓↓ 追加: テーブル構造の初期化 ↓↓↓ */
  initializeTables();
  /* ↑↑↑ 追加 ↑↑↑ */
  setMode('session');
  btnSession.addEventListener('click',()=>setMode('session'));
  btnFull.addEventListener('click',()=>setMode('full'));
  /* ↓↓↓ 変更: イベントリスナーの調整 (sessionSelect変更イベントは不要) ↓↓↓ */
  // sessionSelect.addEventListener('change',...);
  // 検索ボックスのイベントリスナーを調整
  searchBox.addEventListener('input',()=>{
    // 検索はFullモードでのみ動作するように設定
    if(btnFull.classList.contains('active')) {
        renderFull();
    }
  });
}
/* ↓↓↓ 追加: 新しいレンダリング関数群 ↓↓↓ */
/**
 * HTMLテンプレートからテーブル構造を複製し、各コンテナに配置する。
 */
function initializeTables() {
    // Full Schedule用
    const tableFull = tableTemplate.content.cloneNode(true).querySelector('table');
    // 固有のIDを付与
    tableFull.id = 'scheduleTableFull';
    fullScheduleContainer.appendChild(tableFull);
    // Overview用 (Last, Next, AfterNext)
    const panelIds = ['panelLast', 'panelNext', 'panelAfterNext'];
    panelIds.forEach(panelId => {
        const panel = document.getElementById(panelId);
        const container = panel.querySelector('.tablewrap');
        if (container) {
            const table = tableTemplate.content.cloneNode(true).querySelector('table');
            // 例: scheduleTable_panelLast
            table.id = `scheduleTable_${panelId}`;
            container.appendChild(table);
        }
    });
}
/**
 * By Session Overview モードの描画処理。
 */
function renderSessionOverview() {
    const { lastClass, nextClass, afterNextClass } = findRelevantSessions();
    // 各パネルに対応するテーブルIDとデータを指定して描画
    // 過去の授業がない場合はメッセージは表示しない（Class 0が表示されるか、空欄になる）
    renderTable('scheduleTable_panelLast', lastClass);
    // 未来の授業がない場合はメッセージを表示
    renderTable('scheduleTable_panelNext', nextClass, "計画されている授業はありません");
    renderTable('scheduleTable_panelAfterNext', afterNextClass, "計画されている授業はありません");
}
/**
 * 汎用的なテーブルレンダリング関数。
 * 指定されたIDのテーブルに、指定されたアイテムを描画する。
 */
function renderTable(tableId, item, emptyMessage = null) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (item) {
        tbody.appendChild(createRow(item));
    } else if (emptyMessage) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5; 
        td.textContent = emptyMessage;
        td.className = 'empty-message-cell';
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
}
function setMode(mode){
  if(mode==='session'){
    // By Session Overview モード
    btnSession.classList.add('active'); btnSession.setAttribute('aria-selected','true');
    btnFull.classList.remove('active'); btnFull.setAttribute('aria-selected','false');
    /* ↓↓↓ 変更: コンテナ切り替えとOverviewレンダリング ↓↓↓ */
    fullScheduleContainer.style.display = 'none';
    sessionOverviewContainer.style.display = 'block';
    // 検索ボックスはOverviewモードでは無効化し、値をクリア
    searchBox.disabled = true;
    searchBox.value = '';
    renderSessionOverview();
  } else {
    // Full Schedule モード
    btnFull.classList.add('active'); btnFull.setAttribute('aria-selected','true');
    btnSession.classList.remove('active'); btnSession.setAttribute('aria-selected','false');
    /* ↓↓↓ 変更: コンテナ切り替えとFullレンダリング ↓↓↓ */
    sessionOverviewContainer.style.display = 'none';
    fullScheduleContainer.style.display = 'block';
    searchBox.disabled = false; // 検索ボックスを有効化
    renderFull();
  }
}
function filterText(item, text) {
  if (!text) return true;
  const s = text.toLowerCase();
  // 全て String() で囲むことで数値によるエラーを回避
  const name = String(item.class || "").toLowerCase();
  const date = String(item.date || "").toLowerCase();
  const chap = String(item.chapter || "").toLowerCase();
  
  return name.includes(s) || date.includes(s) || chap.includes(s);
}
function renderFull(){
 
  const tbody = document.querySelector('#scheduleTableFull tbody');
  if (!tbody) return;
  tbody.innerHTML='';
  const searchText = searchBox.value;
  scheduleData.forEach(item=>{
    if(filterText(item,searchText)) tbody.appendChild(createRow(item));
  });
}
function createRow(item){
  // DocumentFragmentを使って複数行をまとめて返す
  const frag = document.createDocumentFragment();
  /* セクションタイトル行の処理 */
  if (item.session === SECTION_TITLE_IDENTIFIER) {
    const tr = document.createElement('tr');
    tr.className = 'section-title-row';
    const tdTitle = document.createElement('td');
    tdTitle.colSpan = 5; // 6列から5列に変更
    tdTitle.textContent = item.class;
    tr.appendChild(tdTitle);
    frag.appendChild(tr);
    return frag;
  }
  /* === 1行目: メイン情報 === */
  const trMain = document.createElement('tr');
  const today = new Date();
  const deadlineDate = parseDeadlineAsLocal(item.deadlineClass);
  const deadlineDate2 = parseDeadlineAsLocal(item.deadlineHW);
  const hwClass = (deadlineDate && !isNaN(deadlineDate.getTime())) ? (today <= deadlineDate ? 'hw-due' : 'hw-past') : '';
  const hwClass2 = (deadlineDate2 && !isNaN(deadlineDate2.getTime())) ? (today <= deadlineDate2 ? 'hw-due' : 'hw-past') : '';
  // --- Session Cell (Col 1) ---
  const tdSession = document.createElement('td');
  tdSession.textContent = item.session;
  tdSession.className = "col1 " + hwClass;
  // --- Date Cell (Col 2) ---
  const tdDate = document.createElement('td');
  function formatExcelDate(serial) {
  if (!serial || isNaN(Number(serial))) return serial;
  const date = new Date((Number(serial) - 25569) * 86400 * 1000);
  return `${date.getMonth() + 1}/${date.getDate()}`;
}
  
  const dateContent = formatExcelDate(item.date2 || item.date || '');
  if (item.format) {
    tdDate.innerHTML = `${dateContent}<br><br><span style="font-size:0.85em; color:var(--muted);">${item.format}</span>`;
  } else {
    tdDate.textContent = dateContent;
  }
  tdDate.className = "col-date " + hwClass;
  // --- Chapter Cell (Col 3) ---
  const tdChapter = document.createElement('td');
  tdChapter.innerHTML = item.chapter || ''; 
  tdChapter.className = "col-chapter " + hwClass;
  // --- Class Cell (Col 4) ---
  const tdClass = document.createElement('td');
  const classContent = item.class || ''; 
  tdClass.innerHTML = classContent;
  tdClass.className = "col2 " + hwClass;
  // --- Handout/Docs Cell (Col 5) ---
  const tdHandout = document.createElement('td');
  tdHandout.className = "col3 " + hwClass; 
  
  const handoutRaw = (item.handout || '').replace(/<br\s*\/?>/gi, '\n');
  const handoutEntries = parseEntries(handoutRaw);
  
  handoutEntries.forEach((entry, index) => {
    if (index > 0) {
      tdHandout.appendChild(document.createElement('br'));
    }
    if (entry.url) {
      const a = document.createElement('a');
      a.className = 'handout-link';
      a.textContent = entry.label;
      let isAvailable = true;
      if (entry.availableAfterStr) {
        const availableStartTime = parseAvailableFromAsLocal(entry.availableAfterStr);
        if (!availableStartTime || isNaN(availableStartTime.getTime()) || today < availableStartTime) {
          isAvailable = false;
        }
      }
      if (isAvailable) {
        a.href = entry.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
      } else {
        a.classList.add('disabled');
        a.setAttribute('aria-disabled', 'true');
        if (entry.availableAfterStr) {
          a.title = `Available from ${entry.availableAfterStr}`;
        }
      }
      tdHandout.appendChild(a);
    } else {
      tdHandout.appendChild(document.createTextNode(entry.label));
    }
  });
  // メイン行にセルを追加 (5列)
  [tdSession, tdDate, tdChapter, tdClass, tdHandout].forEach(td=>trMain.appendChild(td));
  frag.appendChild(trMain);
  /* === 2行目: Videos (Homework) === */
  const trVideo = document.createElement('tr');
  trVideo.className = "video-row";
  // 1. スペーサーセルを作成 (Session, Date, Chapter, Classの4列分を埋める)
  const tdSpacer = document.createElement('td');
  tdSpacer.colSpan = 4; 
  tdSpacer.className = "video-spacer"; // 必要に応じてCSSで装飾
  trVideo.appendChild(tdSpacer);
  // 2. コンテンツセルを作成 (Docsの1列分に配置)
  const tdVideos = document.createElement('td');
  // colspanは指定しない（デフォルト1）か、明示的に1を指定
  tdVideos.colSpan = 1; 
  // クラスはDocs列と同じスタイルを継承しつつ、期限の色設定(hwClass2)も適用
  tdVideos.className = "col3 " + hwClass2; 
  // ラベル追加
  const label = document.createElement('span');
  label.className = "video-row-label";
  label.textContent = "次回までの宿題:";
  tdVideos.appendChild(label);
  const videos = parseEntries(item.video);
  if(videos.length){
    const ul = document.createElement('ul'); ul.className='video-list';
    videos.forEach(v=>{
      const li = document.createElement('li');
      if(v.url){
        const anchor = document.createElement('a');
        anchor.className='video-btn';
        anchor.textContent=v.label;
        let isAvailable = true;
        if (v.availableAfterStr) {
          const availableStartTime = parseAvailableFromAsLocal(v.availableAfterStr);
          if (!availableStartTime || isNaN(availableStartTime.getTime()) || today < availableStartTime) {
            isAvailable = false;
          }
        }
        if (isAvailable) {
          anchor.href = v.url;
          anchor.target = '_blank';
          anchor.rel = 'noopener noreferrer';
        } else {
          anchor.classList.add('disabled');
          anchor.setAttribute('aria-disabled', 'true');
          if (v.availableAfterStr) {
            anchor.title = `Available from ${v.availableAfterStr}`;
          }
        }
        li.appendChild(anchor);
      } else {
        li.textContent=v.label;
      }
      ul.appendChild(li);
    });
    tdVideos.appendChild(ul);
  } else {
    // 動画がない場合
    const span = document.createElement('span');
    span.textContent = "None";
    span.style.color = "var(--muted)";
    span.style.fontStyle = "italic";
    tdVideos.appendChild(span);
  }
  
  trVideo.appendChild(tdVideos);
  frag.appendChild(trVideo);
  
  return frag;
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
